<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College AR Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100vh;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .start-screen {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 500px;
            width: 90%;
        }

        .start-screen h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .start-screen p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .file-upload {
            margin-bottom: 30px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .file-input-wrapper:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-label {
            display: block;
            color: #666;
            font-size: 1em;
            pointer-events: none;
        }

        .start-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ar-container {
            display: none;
            width: 100%;
            height: 100vh;
            position: relative;
            background: black;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: #fff;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.3);
        }

        .crosshair::before {
            top: 50%;
            left: 18px;
            right: 18px;
            height: 2px;
            transform: translateY(-50%);
        }

        .crosshair::after {
            left: 50%;
            top: 18px;
            bottom: 18px;
            width: 2px;
            transform: translateX(-50%);
        }

        .instructions {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            text-align: center;
            backdrop-filter: blur(10px);
            max-width: 90%;
        }

        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 20;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 1em;
            pointer-events: auto;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .place-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .place-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2em;
            text-align: center;
            z-index: 30;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .model-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: #333;
        }

        @media (max-width: 768px) {
            .start-screen {
                padding: 30px 20px;
            }
            
            .start-screen h1 {
                font-size: 2em;
            }
            
            .instructions {
                font-size: 1em;
                padding: 12px 20px;
                bottom: 120px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 200px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div class="start-screen" id="startScreen">
            <h1>🎓 College AR Viewer</h1>
            <p>Upload your college 3D model and experience it in augmented reality!</p>
            
            <div class="file-upload">
                <div class="file-input-wrapper">
                    <input type="file" class="file-input" id="objFile" accept=".obj">
                    <label class="file-label" for="objFile">📄 Choose OBJ File</label>
                </div>
                
                <div class="file-input-wrapper">
                    <input type="file" class="file-input" id="mtlFile" accept=".mtl">
                    <label class="file-label" for="mtlFile">🎨 Choose MTL File (Optional)</label>
                </div>
                
                <div id="modelInfo" class="model-info" style="display: none;">
                    <strong>Files Selected:</strong>
                    <div id="fileList"></div>
                </div>
            </div>
            
            <button class="start-btn" id="startAR" disabled>Start AR Experience</button>
            
            <div id="error" class="error" style="display: none;"></div>
        </div>

        <!-- AR Container -->
        <div class="ar-container" id="arContainer">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
            
            <div class="ar-overlay">
                <div class="crosshair"></div>
                <div class="instructions" id="instructions">
                    Point your camera at a flat surface and tap to place the college model
                </div>
                
                <div class="loading" id="loading" style="display: none;">
                    <div class="spinner"></div>
                    <div>Loading 3D Model...</div>
                </div>
            </div>
            
            <div class="controls">
                <button class="control-btn place-btn" id="placeModel">📍 Place Model</button>
                <button class="control-btn" id="resetView">🔄 Reset</button>
                <button class="control-btn" id="backBtn">← Back</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        class CollegeARViewer {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.video = null;
                this.canvas = null;
                this.model = null;
                this.modelPlaced = false;
                this.modelScale = 0.01;
                this.modelRotationY = 0;
                
                this.objFile = null;
                this.mtlFile = null;
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('objFile').addEventListener('change', (e) => this.handleFileSelect(e, 'obj'));
                document.getElementById('mtlFile').addEventListener('change', (e) => this.handleFileSelect(e, 'mtl'));
                document.getElementById('startAR').addEventListener('click', () => this.startARExperience());
                document.getElementById('placeModel').addEventListener('click', () => this.placeModel());
                document.getElementById('resetView').addEventListener('click', () => this.resetView());
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                
                // Touch/click events for placing model
                document.getElementById('canvas').addEventListener('click', (e) => this.onScreenTouch(e));
                document.getElementById('canvas').addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.onScreenTouch(e);
                });
            }

            handleFileSelect(event, fileType) {
                const file = event.target.files[0];
                if (!file) return;

                if (fileType === 'obj') {
                    this.objFile = file;
                    document.querySelector('#objFile + .file-label').textContent = `📄 ${file.name}`;
                } else if (fileType === 'mtl') {
                    this.mtlFile = file;
                    document.querySelector('#mtlFile + .file-label').textContent = `🎨 ${file.name}`;
                }

                this.updateFileInfo();
                this.checkReadyToStart();
            }

            updateFileInfo() {
                const modelInfo = document.getElementById('modelInfo');
                const fileList = document.getElementById('fileList');
                
                if (this.objFile || this.mtlFile) {
                    let info = '';
                    if (this.objFile) info += `<br>• OBJ: ${this.objFile.name}`;
                    if (this.mtlFile) info += `<br>• MTL: ${this.mtlFile.name}`;
                    
                    fileList.innerHTML = info;
                    modelInfo.style.display = 'block';
                } else {
                    modelInfo.style.display = 'none';
                }
            }

            checkReadyToStart() {
                const startBtn = document.getElementById('startAR');
                startBtn.disabled = !this.objFile;
            }

            async startARExperience() {
                try {
                    // Hide start screen
                    document.getElementById('startScreen').style.display = 'none';
                    document.getElementById('arContainer').style.display = 'block';
                    
                    // Initialize camera
                    await this.initializeCamera();
                    
                    // Initialize Three.js
                    this.initializeThreeJS();
                    
                    // Load 3D model
                    await this.load3DModel();
                    
                    // Start render loop
                    this.animate();
                    
                } catch (error) {
                    this.showError('Failed to start AR experience: ' + error.message);
                    this.goBack();
                }
            }

            async initializeCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    this.video = document.getElementById('video');
                    this.video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            this.video.play();
                            resolve();
                        };
                    });
                } catch (error) {
                    throw new Error('Camera access denied or unavailable');
                }
            }

            initializeThreeJS() {
                this.canvas = document.getElementById('canvas');
                
                // Scene
                this.scene = new THREE.Scene();
                
                // Camera
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    1000
                );
                this.camera.position.set(0, 0, 0);
                
                // Renderer
                this.renderer = new THREE.WebGLRenderer({
                    canvas: this.canvas,
                    alpha: true,
                    antialias: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x000000, 0);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(1, 1, 1);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                
                // Handle window resize
                window.addEventListener('resize', () => this.onWindowResize());
            }

            async load3DModel() {
                document.getElementById('loading').style.display = 'block';
                
                try {
                    // Create object URLs for the files
                    const objURL = URL.createObjectURL(this.objFile);
                    let mtlURL = null;
                    if (this.mtlFile) {
                        mtlURL = URL.createObjectURL(this.mtlFile);
                    }
                    
                    const loader = new THREE.OBJLoader();
                    
                    // Load MTL if available
                    if (mtlURL) {
                        const mtlLoader = new THREE.MTLLoader();
                        const materials = await new Promise((resolve, reject) => {
                            mtlLoader.load(mtlURL, resolve, undefined, reject);
                        });
                        materials.preload();
                        loader.setMaterials(materials);
                    }
                    
                    // Load OBJ
                    const object = await new Promise((resolve, reject) => {
                        loader.load(objURL, resolve, undefined, reject);
                    });
                    
                    // Process the loaded model
                    this.model = new THREE.Group();
                    this.model.add(object);
                    
                    // Scale and position the model
                    this.model.scale.setScalar(this.modelScale);
                    this.model.position.set(0, -2, -5);
                    this.model.rotation.x = -Math.PI / 6;
                    
                    // Add to scene but make it invisible initially
                    this.model.visible = false;
                    this.scene.add(this.model);
                    
                    // Clean up object URLs
                    URL.revokeObjectURL(objURL);
                    if (mtlURL) URL.revokeObjectURL(mtlURL);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('instructions').textContent = 'Tap the screen to place your college model!';
                    
                } catch (error) {
                    document.getElementById('loading').style.display = 'none';
                    throw new Error('Failed to load 3D model: ' + error.message);
                }
            }

            onScreenTouch(event) {
                if (!this.model || this.modelPlaced) return;
                
                event.preventDefault();
                this.placeModel();
            }

            placeModel() {
                if (!this.model) return;
                
                // Make model visible and mark as placed
                this.model.visible = true;
                this.modelPlaced = true;
                
                // Update instructions
                document.getElementById('instructions').textContent = 'College model placed! Use controls to reset or adjust.';
                
                // Add some animation
                this.model.rotation.y = 0;
                this.animateModelEntrance();
            }

            animateModelEntrance() {
                let startTime = Date.now();
                const duration = 1000; // 1 second
                const startScale = 0;
                const endScale = this.modelScale;
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Ease out animation
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    const currentScale = startScale + (endScale - startScale) * easeProgress;
                    
                    this.model.scale.setScalar(currentScale);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                animate();
            }

            resetView() {
                if (this.model) {
                    this.model.visible = false;
                    this.modelPlaced = false;
                    this.model.position.set(0, -2, -5);
                    this.model.rotation.set(-Math.PI / 6, 0, 0);
                    this.model.scale.setScalar(this.modelScale);
                    document.getElementById('instructions').textContent = 'Tap the screen to place your college model!';
                }
            }

            goBack() {
                // Stop camera stream
                if (this.video && this.video.srcObject) {
                    const tracks = this.video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
                
                // Show start screen
                document.getElementById('arContainer').style.display = 'none';
                document.getElementById('startScreen').style.display = 'flex';
                
                // Clean up
                if (this.renderer) {
                    this.renderer.dispose();
                }
                this.modelPlaced = false;
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Rotate model continuously when placed
                if (this.model && this.model.visible) {
                    this.model.rotation.y += 0.005;
                }
                
                this.renderer.render(this.scene, this.camera);
            }

            onWindowResize() {
                if (this.camera && this.renderer) {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            new CollegeARViewer();
        });

        // Add OBJLoader since it's not included in the base Three.js
        !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e.THREE||{},e.THREE)}(this,function(e,t){"use strict";class r extends t.Loader{constructor(e){super(e)}load(e,t,r,o){const n=this,s=new t.FileLoader(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,function(e){try{t(n.parse(e))}catch(t){o?o(t):console.error(t),n.manager.itemError(e)}},r,o)}setMaterials(e){return this.materials=e,this}parse(e){const r=new t.Group;let o,n,s,i;function a(e){const r=e.trim().split(/\s+/);return r.shift(),r}function l(e){const t=parseInt(e);return(t>=0?t-1:t+o.length/3)*3}function c(e){const t=parseInt(e);return(t>=0?t-1:t+n.length/2)*2}function f(e){const t=parseInt(e);return(t>=0?t-1:t+s.length/3)*3}const u=/^o /,d=/^g /,p=/^usemtl /,h=/^mtllib /,m=/^s /,g=/^f /,y=/^l /,b=/^v /,x=/^vn /,w=/^vt /,v=/\s+/;let T,M,E,A,j,S,F,O,P,U=0;const C=[];for(let t=0,r=e.length;t<r;t++){const r=e.charCodeAt(t);10===r&&U++}let L="",G=0;const V=[];for(let t=0,r=e.length;t<r;t++){const r=e.charCodeAt(t);if(10===r){const e=L.trim();if(0!==e.length){const t=e.charAt(0);if("#"!==t){if(u.test(e))L=L.substring(2).trim(),T=L,G=0;else if(d.test(e))L=L.substring(2).trim(),M=L;else if(p.test(e))L=L.substring(7).trim(),E=L;else if(h.test(e))L=L.substring(7).trim(),A=L;else if(m.test(e)){if(L=L.substring(2).trim(),j="0"===L?0:parseInt(L),"0"!==j&&!isNaN(j))throw new Error("Smooth groups are not supported")}else if(g.test(e)){L=L.substring(2).trim();const e=L.split(v),t=[];for(let r=0,n=e.length;r<n;r++){const n=e[r].trim();if(0===n.length)continue;const s=n.split("/");if(t.push(parseInt(s[0])),void 0===s[1]||""===s[1])t.push(null);else{if(isNaN(parseInt(s[1])))throw new Error("NaN vertex texture index at face index "+G+", face vertex index "+r);t.push(parseInt(s[1]))}if(void 0===s[2]||""===s[2])t.push(null);else{if(isNaN(parseInt(s[2])))throw new Error("NaN vertex normal index at face index "+G+", face vertex index "+r);t.push(parseInt(s[2]))}}const r=[];for(let e=3;e<t.length;e+=3)r.push(t[0],t[1],t[2],t[e-2],t[e-1],t[e]);V.push(r),G++}else if(y.test(e)){const e=a(L);S=[];for(let t=0,r=e.length;t<r;t+=1)S.push(parseInt(e[t]))}else if(b.test(e)){if(L=L.replace(b,""),F=L.split(v),void 0===o&&(o=[]),0===F.length)throw new Error("Unexpected vertex statement");for(;F.length>=3;)o.push(parseFloat(F.shift()),parseFloat(F.shift()),parseFloat(F.shift()));if(F.length>0)throw new Error("Vertex statement with length != 3 found")}else if(x.test(e)){if(L=L.replace(x,""),O=L.split(v),void 0===s&&(s=[]),3!==O.length)throw new Error("Vertex normal statement with length != 3 found");s.push(parseFloat(O[0]),parseFloat(O[1]),parseFloat(O[2]))}else if(w.test(e)){if(L=L.replace(w,""),P=L.split(v),void 0===n&&(n=[]),P.length<2||P.length>3)throw new Error("Vertex texture statement with length != 2 or 3 found");n.push(parseFloat(P[0]),parseFloat(P[1]),2===P.length?0:parseFloat(P[2]))}else if(0!==G){const e=L.match(/\s*([*\d\w\-\.]+)/);null!==e&&""!==e[1]&&(i=e[1].trim())}}else console.warn('THREE.OBJLoader: Unexpected line: "'+e+'"');G++}L=""}else L+=e.charAt(t)}for(let e=0,t=V.length;e<t;e++){const t=V[e];let r=t[0];for(let e=1,n=t.length-1;e<n;e+=3){const n=r,s=t[e],i=t[e+1],a=t[e+2],u=t[e+3],d=t[e+4];if(void 0===o)throw new Error("Missing vertex data");let p,h,m,g,y,b;if(void 0!==n&&(p=l(n)),void 0!==s&&(h=l(s)),void 0!==i&&(m=l(i)),void 0!==a&&(g=c(a)),void 0!==u&&(y=c(u)),void 0!==d&&(b=c(d)),void 0===C[0]&&(C[0]=[]),void 0===C[1]&&(C[1]=[]),void 0===C[2]&&(C[2]=[]),C[0].push(o[p],o[p+1],o[p+2]),C[0].push(o[h],o[h+1],o[h+2]),C[0].push(o[m],o[m+1],o[m+2]),void 0!==n&&n>0&&(void 0===C[3]&&(C[3]=[]),C[3].push(n),C[3].push(s),C[3].push(i)),void 0!==g&&(void 0===C[4]&&(C[4]=[]),C[4].push(n[g],n[g+1])),void 0!==y&&(void 0===C[4]&&(C[4]=[]),C[4].push(n[y],n[y+1])),void 0!==b&&(void 0===C[4]&&(C[4]=[]),C[4].push(n[b],n[b+1])),void 0!==p){const e=f(p),t=f(h),r=f(m);void 0===C[5]&&(C[5]=[]),C[5].push(s[e],s[e+